<html>
  <style>


  </style>

  <head>

  </head>

  <body>

    <div id="DrawdownChart">

      <div id="programmatic_dashboard_divLine" style="border: 1px solid #ccc">
        <table class="columns" style="height: 30px">
          <tr>
            <td>
              <div id="programmatic_control_divLine" style="position:absolute; right:15px; top: 0px; z-index: 20;"></div>
            </td>
          </tr>
        </table>
        <div id="programmatic_chart_divBar" style="width: 100%; height: 500px; "></div>
      </div>

    </div>

  </body>

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
  <script type="text/javascript">


  // Load the Visualization API and the corechart package.
  google.charts.load('current', {
    'packages': ['corechart', 'controls'],
  });
// Set a callback to run when the Google Visualization API is loaded.
google.charts.setOnLoadCallback(Init2);

function Init2() {
  //$.get("http://intranet.wealth.rbsgrp.net/pands/investanalytics/Documents/FactorData.csv", function(csvString2) {
 //   var DataABar = $.csv.toArrays(csvString2, {
   //   onParseValue: $.csv.hooks.castToScalar
  //  });
    
    var DataABar = [
     ["Day", "AssetClass", "PortA", "PortB", "PortC"],
    ["CurrentLevel", "UK Treasury", 1800, 1810, 1820],
    ["CurrentLevel", "Global Credit", 1300, 1310, 1320],
     ["CurrentLevel", "High Yield", 1600, 1610, 1620],
     ["Change3M", "UK Treasury", 900, 910, 920],
     ["Change3M", "Global Credit", 300, 310, 320],
     ["Change3M", "High Yield", 1927, 1937, 1947],
      ["Change1yr", "UK Treasury", 300, 10, 90],
      ["Change1yr", "Global Credit", 100, 10, 30],
     ["Change1yr", "High Yield", 927, 937, 197]
     ];
     
    // Create the data table.
    var dataBarInitial = google.visualization.arrayToDataTable(DataABar); //YTD = 0
    //reads in the portfolio names from the colum headers of the CSV
    var dataBTable = new google.visualization.DataTable()
    dataBTable.addColumn('string', 'Portfolio Name')
    dataBTable.addColumn('number', 'Portfolio No') // just an aribtary

    for (var k = 2; k < dataBarInitial.getNumberOfColumns(); k++) {
      var test = dataBarInitial.getColumnLabel(k)
      dataBTable.addRow([test, 1])

    }

    var dashboardBar = new google.visualization.Dashboard(
      document.getElementById('programmatic_dashboard_divBar'));
    var initStateBubble = {
      selectedValues: []
    };


    initStateBubble.selectedValues.push("CMAFPORTBAL", "PPF 3 TAA", "TPSPORTBAL", "ARC GBP BAL");
    var programmaticFilterBar = new google.visualization.ControlWrapper({
      'controlType': 'CategoryFilter',
      'containerId': 'programmatic_control_divBar',
      'dataTable': dataBTable,
      'options': {
        'filterColumnIndex': 0,
        'ui': {
          'labelStacking': 'vertical',
          'label': '',
          'caption': 'Select Product',
          'allowTyping': true,
          'allowMultiple': true,
          'cssClass': 'filter',
          'sortValues': 'true'
        }
      }
      // state: initStateBubble
    });
    var chartBar = new google.visualization.ChartWrapper({
      'chartType': 'ColumnChart',
      'containerId': 'programmatic_chart_divBar',
      'dataTable': dataBarInitial,
      'options': {
        'pieSliceText': 'label',
        'fontName': 'Gill Sans',
        'colors': ['#838c83', '#ffe075', '#006084', '#bde3dc', '#006964', '#70c7ad', '#89774d', '#f2c257'],
        chartArea: {
          left: 50,
          bottom: 120,
          width: "79%",
          height: "74%"
        },
        vAxis: {
          format: '#,###.00',
          baseline: 0
        },
        hAxis: {
          slantedText: true,
          slantedTextAngle: 90
        },
        animation: {
          duration: 1000,
          easing: 'out',
          startup: false
        },
      }
    });
    // this filters the data to Current level
    var aBar = dataBarInitial.getFilteredRows([{
      column: 0,
      value: 'CurrentLevel' // filter for both chart type and time horizon from single CSV
    }])


    var columnsToShowDefault = [1, 3, 11, 17, 23];

    //default is CurrentLevel and deefault colums set here too
    chartBar.setView({
      'columns': columnsToShowDefault,
      'rows': aBar // GBP initial
    })
    programmaticFilterBar.draw()

    //chartBar.draw(filterdataBar);
    var columnsToShow = columnsToShowDefault; // default of this variable unless modidifed by funciton below
    //does the category filter for the portfolios
    google.visualization.events.addListener(programmaticFilterBar, 'statechange', function() {
      var state = programmaticFilterBar.getState();
      columnsToShow = [1]
      if (state.selectedValues.length > 0) {
        for (var i = 0; i < state.selectedValues.length; i++) {
          // loops through each of the column in the factor data table
          for (var k = 2; k < dataBarInitial.getNumberOfColumns(); k++) {
            if (dataBarInitial.getColumnLabel(k) == state.selectedValues[i]) { //we look for colum label that is equal to a selected item
              columnsToShow.push(k)
            }
          }
        }
      } else {
        // if no selection revert to default
        // need to add the default column to columns to show if all portfolios unticked
        columnsToShow = columnsToShowDefault //these are the cols that show if nothing selected
      }
      chartBar.setView({
        'columns': columnsToShow,
        'rows': aBar // GBP initial
      })
      chartBar.draw()
    });
    //Area covers button interactions
    var button1 = document.getElementById("b1Bar");
    var button2 = document.getElementById("b2Bar");
    var button3 = document.getElementById("b3Bar");
    var buttoncolour = "#555555"
    //function runs on button click
    function drawBarChart() {
      // Disabling the button while the chart is drawing.
      button1.disabled = true;
      button2.disabled = true;
      button3.disabled = true;
      google.visualization.events.addListener(chartBar, 'ready',
        function() {
          button1.disabled = false;
          button2.disabled = false;
          button3.disabled = false;
        });
      chartBar.draw()
    }
    //runs if the 1M button is clicked
    button1.onclick = function() {
      button1.style.background = buttoncolour
      button1.style.color = "white";
      button2.style.background = "#F5A623"
      button3.style.background = "#F5A623"
      aBar = dataBarInitial.getFilteredRows([{
        column: 0,
        value: 'CurrentLevel' // filter for both chart type and time horizon from single CSV
      }])
      chartBar.setView({
        'columns': columnsToShow,
        'rows': aBar // GBP initial
      })
      drawBarChart();
      button1.disabled = true;
    };
    //runs if the YTD button is clicked
    button2.onclick = function() {
      button2.style.background = buttoncolour
      button2.style.color = "white";
      button1.style.background = "#F5A623"
      button3.style.background = "#F5A623"
      aBar = dataBarInitial.getFilteredRows([{
        column: 0,
        value: 'Change3M' // filter for both chart type and time horizon from single CSV
      }])
      chartBar.setView({
        'rows': aBar, // GBP initial
        'columns': columnsToShow
      })
      drawBarChart();
      button2.disabled = true;
    };
    // runs if YTD is clicked
    button3.onclick = function() {
      button3.style.background = buttoncolour
      button3.style.color = "white";
      button1.style.background = "#F5A623"
      button2.style.background = "#F5A623"
      aBar = dataBarInitial.getFilteredRows([{
        column: 0,
        value: 'Change1yr' // filter for both chart type and time horizon from single CSV
      }])
      chartBar.setView({
        'rows': aBar, // GBP initial
        'columns': columnsToShow
      })
      drawBarChart();
      button3.disabled = true;
    };
    // sets default button colours
    button1.style.background = buttoncolour
    button1.style.color = "white";
    button2.style.background = "#F5A623"
    button3.style.background = "#F5A623"
    $(window).resize(function() {
      drawBarChart();
    });

    var UIOverviewtab = document.getElementById("ui-id-3");
    UIOverviewtab.onclick = function() {

      //draws chart
      chartBar.draw()

    }


    var DataLine = [
      ["Day", "Excess Return", "Trigger 1", "Trigger 2", "theme"],
      ["2017/04/12", 100, 150, 140, 'TPS'],
      ["2017/04/13", 110, 150, 140, 'TPS'],
      ["2017/04/14", 160, 150, 140, 'TPS'],
      ["2017/04/17", 120, 150, 140, 'TPS'],
      ["2017/04/18", 110, 150, 140, 'TPS'],
      ["2017/04/19", 131, 150, 140, 'TPS'],
      ["2017/04/20", 137, 150, 140, 'TPS'],
      ["2017/04/21", 139, 150, 140, 'TPS'],
      ["2017/04/24", 150, 150, 140, 'TPS']
    ];

    var dataLineInitial = google.visualization.arrayToDataTable(DataLine); //YTD = 0

    dataLineInitial.insertColumn(0, 'date', dataLineInitial.getColumnLabel(0));
    // copy values from column 1 (old column 0) to column 0, converted to numbers
    for (var i = 0; i < dataLineInitial.getNumberOfRows(); i++) {

      val = dataLineInitial.getValue(i, 1);
      //document.write(new Date(val));

      dataLineInitial.setValue(i, 0, new Date(val));
    }
    // remove column 1 (the old column 0)
    dataLineInitial.removeColumn(1);

    var dashboardLine = new google.visualization.Dashboard(
      document.getElementById('programmatic_dashboard_divLine'));

    var programmaticFilterLineChart = new google.visualization.ControlWrapper({
      'controlType': 'CategoryFilter',
      'containerId': 'programmatic_control_divLine',
      'options': {
        'filterColumnIndex': 4,
        'ui': {
          'labelStacking': 'vertical',
          'label': '',
          'caption': 'Select Product',
          'allowTyping': true,
          'allowMultiple': true,
          'cssClass': 'filter',
          'sortValues': 'true'
        }
      }
    });

    var chartLine = new google.visualization.ChartWrapper({
      'chartType': 'LineChart',
      'containerId': 'programmatic_chart_divBar',
      'options': {
        'pieSliceText': 'label',
        'pointSize': 8,
        'pointShape': 'square',
        'fontName': 'Gill Sans',
        'series': {
          1: {
            lineDashStyle: [2, 2],
            type: "steppedArea",
            areaOpacity: 0.15,
            enableInteractivity: false
          },
          2: {
            lineDashStyle: [2, 2],
            type: "steppedArea",
            areaOpacity: 0.15,
            enableInteractivity: false
          }
        },
        'colors': ['blue', 'orange', 'red'],
        chartArea: {
          left: 50,
          bottom: 120,
          width: "75%",
          height: "74%"
        },
        vAxis: {
          format: '#,###.00',
          baseline: 0
        },
        hAxis: {
          slantedText: false,
          slantedTextAngle: 45,
          format: 'dd MMM yyyy'
          //type: 'category'
        },
        animation: {
          duration: 1000,
          easing: 'out',
          startup: false
        },
      }
    });

    chartLine.setView({
      'columns': [0, 1, 2, 3]
    })

    dashboardLine.bind(programmaticFilterLineChart, chartLine);
    dashboardLine.draw(dataLineInitial);

    $(window).resize(function() {
      dashboardLine.draw(dataLineInitial);
    });


 // })
}


</script>

</html>

